# Skillbox_diploma_infra

## Приготовления

Прежде всего требуется подготовить инструменты для работы.
Для разворачивания инфраструктуры будет использован Terraform.
Для настройки хостов будет использован Ansible.

## Terraform установка

### Установка вручную

Будет приведён пример установки на Linux.

Вы можете скачать дистрибутив Terraform для из [зеркала](https://hashicorp-releases.yandexcloud.net/terraform/) Yandex или установить напрямую используя vpn.
После загрузки добавьте путь к папке, в которой находится исполняемый файл, в переменную PATH:

```shell
export PATH=$PATH:/path/to/terraform
```

После чего сделать source на .bashrc или запустить новый терминал.

### Настройка зеркала провайдеров

Далее следует создать в каталоге пользователя файл .terraformrc и вписать в него следующий текст.

```shell
provider_installation {
  network_mirror {
    url = "https://terraform-mirror.yandexcloud.net/"
    include = ["registry.terraform.io/*/*"]
  }
  direct {
    exclude = ["registry.terraform.io/*/*"]
  }
}
```

По итогу можно будет пользоваться terraform без использования VPN.

## Ansible установка

Существует множество [способов](https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html) установки, но в конечном итоге есть 2 простых способа:

1. Установить пакетным менеджером системы 
2. Установить пакетным менеджером python

### Установка с систему

На примере Fedora.

```shell
sudo dnf install -y ansible
```

На примере Ubuntu.

```shell
sudo apt install -y ansible
```

### Установка через pip

```shell
python3 -m pip install --user ansible
```

Рекомендуется воспользоваться первым способом, т.к. многие дистрибутивы могут ругаться если ставить ansible таким способом без отдельного окружения.

## Подготовка проекта

Для проекта был выбран провайдер Selectel за самую доступную документацию и отличную техподдержку.

### Подготовка в админке провайдера

Ссылка на провайдера - <https://my.selectel.ru>
Ссылка на документацию провайдера - <https://docs.selectel.ru/terraform/quickstart/>

Сперва нужно создать сервисного пользователя для того чтобы terraform смог подключиться к провайдеру.
Делается это в разделе Аккант - Управдение доступом - Сервичные пользователи.
Достаточно будет создать пользователя с правами 'Администратор аккаунта' и 'Администратор пользователей'.

### Подготовка файла с переменными для Terraform

Для работы проекта требуются указать логин и пароль пользователей.
Чтобы не раскрывать эти данные, то их следует вынести в отдельный файл с переменными, который не отслеживается в проекте и должен быть сохранён дополнительно в качестве резервной копии.

В каталоге проекта Terraform/Selectel создайте файл vars.tf

Пример содержимого файла.

```shell
variable "service_admin_username" {
  type        = string
  description = "Имя сервисного пользователя админа"
  default     = ""
  sensitive = true
}

variable "service_admin_password" {
  type        = string
  description = "Пароль сервисного пользователя админа"
  default     = ""
  sensitive = true
}

variable "service_project_username" {
  type        = string
  description = "Имя сервисного пользователя проекта"
  default     = ""
  sensitive = true
}

variable "service_project_password" {
  type        = string
  description = "Пароль сервисного пользователя проекта"
  default     = ""
  sensitive = true
}

variable "selectel_account" {
  type        = string
  description = "id аккаунта selectel"
  default     = ""
  sensitive = true
}
```

В первые 2 переменные требуется вписать логин и пароль сервисного пользователя администратора, который был создан в админке провайдера ранее.
В 3 и 4 переменные требуется записать данные уже сервисного пользователя проекта. 
Сервисный пользователь проекта будет создаваться с помощью terraform, а не в админке как предыдущий, поэтому его данные следует придумать здесь и в будущем менять именно здесь.

Переменную selectel_account можно получить из админки, это номер аккаунта справа сверху на странице. Будет вида - "Аккаунт 123456", нужен только номер.

Более полную информацию по примеру от провайдера можно посмотреть по ссылке - <https://docs.selectel.ru/terraform/examples/cloud-load-balancers/create-load-balancer-and-server/>

### Регистрация доменного имени

Для проекта потребуется домен.
Где бы он не был получен нужно чтобы он был делегирован провайдеру.

1. Перейдите в панель управления доменного регистратора, у которого зарегистрирован ваш домен.
2. В NS-записях замените значения на NS-серверы Selectel: a.ns.selectel.ru, b.ns.selectel.ru, c.ns.selectel.ru, d.ns.selectel.ru. Каждый сервер должен быть указан в отдельной записи.

Проще всего будет зарегистрировать новый домен чтобы избежать проблем с делегацией.
Регистратор - <https://partner.r01.ru>

### Подготовка ключей для ssh

Для удаленной настройки сервера и клонирования репозитория проекта потребуются ключи.
По хорошему потребуется 2 ключа. Один для провайдера и один для репозитория.
Ключ для клонирования репозитория требуется создать с пустым паролем, т.к. на текущий момент в ansible не передаются такие данные и клонирование встанет.

```bash
ssh-keygen -t rsa
```

По умолчанию ключи сохраняются в скрытом пользовательском каталоге ~/.ssh/, если не выбрать другой.

В файле Terraform/selectel/ssh.tf укажите путь до открытого ключа, который будет использоваться на сервере.
В файле Ansible/setupe_project/vars/main.yml в переменных key_path и git_key измените путь и имя ключа на свои.

Далее чтобы ключи автоматически применялись следует использовать команду

```bash
ssh-add путь-к-ключу
```

## Инициализация проекта

Как только все приготовления будут завершены можно приступать к созданию инфраструктуры.

### Terraform развёртывание

Сперва нужно зайти в каталог проекта с файлами Terraform.

```bash
cd Terraform/Selectel
```

Теперь нужно инициализировать провайдера

```bash
terraform init
```

Теперь развёртываем инфраструктуру

```bash
terraform apply
```

Будет выведено большое сообщение о предстоящих работах, которое следует подтвердить вписав 'yes'.

Как только terraform закончит работу, то выведет адрес балансировщика на котором уже настроен ssh маршрут до сервера.
Этот адрес следует вписать в файл Ansible/inventory.ini
После окончания работ этот маршрут следует отключить. Параметр для этого можно найти в файле Terraform/Selectel/load_balancer.tf

### Ansible развертывание

Перейдём в каталог с Ansible из Terraform

```bash
cd ../../Ansible
```

Для полного развертывания проекта на текущий момент придуманы 3 роли

1. setup_web_server.yml - первичная настройка сервера, требуется лишь раз
2. setup_project.yml - клонирует и собирает проект из репозитория.
3. start_project.yml - запускает контейнер с веб-сервером

Их следует применить по порядку.

Чтобы изменить ветку для клонирования с репозитория нужно изменить параметр 'version' в блоке 'Clone a repo' файла Ansible/setup_project/tasks/main.yml

